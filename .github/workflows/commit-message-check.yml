name: Commit Message Check

on:
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Validate commit messages
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const { data: commits } = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber
            });
            const regex = /^(feat|fix|refactor|chore|docs|test|ci|perf|build)(\!)?: .+/;
            const mergePrefix = /^Merge /;
            const invalid = [];
            for (const c of commits) {
              const msg = c.commit.message;
              if (mergePrefix.test(msg)) continue;
              if (!regex.test(msg)) {
                invalid.push({ sha: c.sha.slice(0, 7), msg: msg.split('\n')[0] });
              }
            }
            if (invalid.length > 0) {
              const list = invalid.map(i => `- ${i.sha}: ${i.msg}`).join('\n');
              core.setFailed(
                'Some commits do not follow Conventional Commits format.\n' +
                'Example: feat: add release orchestrator\n\n' +
                'Invalid commits:\n' + list
              );
            }
